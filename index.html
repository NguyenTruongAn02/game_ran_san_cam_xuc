<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>R·∫Øn SƒÉn M·ªìi ‚Äì MXH an to√†n (Joystick + Avatar + Nhi·ªÅu m·ªìi/nguy c∆°)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --ink: #e5e7eb;
            --good: #16a34a;
            --bad: #dc2626;
            --accent: #38bdf8;
        }

        body {
            background: linear-gradient(180deg, #0b1220, #0f172a 30%, #0b1220 100%);
            color: var(--ink);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        }

        .wrap {
            max-width: 480px;
            margin: 0 auto;
            padding: 12px;
        }

        .cardx {
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
            padding: 14px;
        }

        #board {
            width: 92vw;
            max-width: 440px;
            aspect-ratio: 1/1;
            background: #0a0f1d;
            border-radius: 16px;
            border: 2px solid #1f2937;
            touch-action: none;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin: 10px 0 12px;
        }

        .pill {
            background: #0b1327;
            border: 1px solid #1f2937;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
        }

        .btn-pill {
            border-radius: 999px;
        }

        .note {
            font-size: .9rem;
            opacity: .9;
        }

        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .toast-tip {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            /* cƒÉn gi·ªØa c·∫£ ngang & d·ªçc */
            background: #0b1327;
            border: 1px solid #1f2937;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 1.05rem;
            /* d·ªÖ ƒë·ªçc h∆°n */
            z-index: 4000;
            /* n·ªïi tr√™n joystick */
            text-align: center;
            max-width: 85vw;
            pointer-events: none;
            /* kh√¥ng ch·∫∑n thao t√°c k√©o joystick */
            box-shadow: 0 10px 30px rgba(0, 0, 0, .45);
        }

        .heart {
            color: #ef4444;
            margin-right: 2px;
        }

        .badge-good {
            background: var(--good);
        }

        .badge-bad {
            background: var(--bad);
        }

        canvas {
            border-radius: 16px;
        }

        .modal-backdrop.show {
            opacity: .35;
        }

        .avatar-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin: 8px 0 6px;
        }

        .avatar-btn {
            font-size: 22px;
            line-height: 1;
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 1px solid #334155;
            background: #0b1327;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-btn.active {
            outline: 2px solid #38bdf8;
        }

        .joy-wrap {
            margin-top: 12px;
            display: flex;
            justify-content: center;
        }

        .joystick {
            position: relative;
            width: 160px;
            height: 160px;
            touch-action: none;
        }

        .joy-base {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #0c1a35, #0b1327 60%);
            border: 2px solid #1f2937;
        }

        .joy-stick {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 64px;
            height: 64px;
            margin-left: -32px;
            margin-top: -32px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #1f3b73, #16233e 60%);
            border: 2px solid #2b3c5f;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .45);
        }

        .dpad {
            display: none;
            grid-template-columns: 64px 64px 64px;
            grid-template-rows: 64px 64px 64px;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .dpad button {
            background: #16233e;
            border: 1px solid #2b3c5f;
            width: 64px;
            height: 64px;
            border-radius: 14px;
            color: #cfe9ff;
            font-weight: 700;
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="cardx">
            <h4 class="mb-1">R·∫Øn SƒÉn M·ªìi: <span class="text-info">Quan h·ªá MXH an to√†n</span></h4>
            <div class="note">K√©o <b>joystick</b> ƒë·ªÉ ƒëi·ªÅu khi·ªÉn. Thu th·∫≠p <span class="badge badge-good">AN TO√ÄN</span>,
                tr√°nh <span class="badge badge-bad">NGUY C∆†</span>. Ch·ªçn linh v·∫≠t cho ƒë·∫ßu r·∫Øn b√™n d∆∞·ªõi.</div>

            <div class="hud">
                <div class="pill">ƒêi·ªÉm: <span id="score">0</span></div>
                <div class="pill">T·ªëc ƒë·ªô: <span id="speed">1x</span></div>
                <div class="pill">Tim: <span id="hearts"></span></div>
                <button id="btnRestart" class="btn btn-sm btn-outline-info btn-pill">Ch∆°i l·∫°i</button>
            </div>

            <div class="avatar-row">
                <span class="small opacity-75 me-1">Linh v·∫≠t:</span>
                <button class="avatar-btn active" data-avatar="snake" title="R·∫Øn">üêç</button>
                <button class="avatar-btn" data-avatar="cat" title="M√®o">üê±</button>
                <button class="avatar-btn" data-avatar="dog" title="Ch√≥">üê∂</button>
                <button class="avatar-btn" data-avatar="panda" title="G·∫•u tr√∫c">üêº</button>
            </div>

            <canvas id="board"></canvas>

            <div class="legend">
                <div><span class="dot" style="background:var(--good)"></span><small>H√†nh vi an to√†n</small></div>
                <div><span class="dot" style="background:var(--bad)"></span><small>H√†nh vi nguy c∆°</small></div>
            </div>

            <div class="joy-wrap">
                <div class="joystick" id="joystick">
                    <div class="joy-base"></div>
                    <div class="joy-stick" id="joyStick"></div>
                </div>
            </div>

            <div class="dpad" aria-label="D-Pad">
                <span></span><button id="up">‚ñ≤</button><span></span>
                <button id="left">‚óÄ</button><span></span><button id="right">‚ñ∂</button>
                <span></span><button id="down">‚ñº</button><span></span>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="endModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background:#0b1327;color:#e5e7eb;border-radius:16px;border:1px solid #1f2937">
                <div class="modal-header">
                    <h5 class="modal-title">K·∫øt th√∫c tr√≤ ch∆°i</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ƒêi·ªÉm:</strong> <span id="finalScore">0</span></p>
                    <div class="small">
                        <p class="mb-1"><strong>B√†i h·ªçc r√∫t ra:</strong></p>
                        <ul class="mb-0" id="tipsList"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-info" id="playAgain" data-bs-dismiss="modal">Ch∆°i l·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast-tip d-none"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (() => {
            const canvas = document.getElementById('board');
            const ctx = canvas.getContext('2d');
            function sizeCanvas() { const w = Math.min(window.innerWidth * 0.92, 440); canvas.width = Math.round(w); canvas.height = Math.round(w); }
            sizeCanvas(); window.addEventListener('resize', sizeCanvas);

            const GRID = 20;
            const INNER_MARGIN = 2;       // c√°ch t∆∞·ªùng ‚â• 2 √¥
            const HEAD_SAFE_DIST = 4;     // c√°ch ƒë·∫ßu r·∫Øn theo Manhattan
            const FOOD_MAX = 5;
            const BAD_MAX = 5;

            const GOOD_TIPS = [
                "Ch·ªâ k·∫øt b·∫°n v·ªõi ng∆∞·ªùi quen ho·∫∑c ƒë√£ x√°c th·ª±c.", "Kh√¥ng g·ª≠i ·∫£nh/clip nh·∫°y c·∫£m cho b·∫•t k·ª≥ ai.",
                "B·∫≠t x√°c th·ª±c 2 l·ªõp, ƒë·∫∑t m·∫≠t kh·∫©u m·∫°nh.", "ƒê·ªçc k·ªπ h·ªì s∆°, ki·ªÉm tra avatar & l·ªãch s·ª≠ ho·∫°t ƒë·ªông.",
                "B√°o c√°o & ch·∫∑n t√†i kho·∫£n c√≥ d·∫•u hi·ªáu l·ª´a ƒë·∫£o.", "Kh√¥ng chia s·∫ª th√¥ng tin c√° nh√¢n quan tr·ªçng.",
                "T√¥n tr·ªçng ng∆∞·ªùi kh√°c, kh√¥ng b√¥i nh·ªç/l√†m nh·ª•c.", "H·ªèi ng∆∞·ªùi l·ªõn/gi√°o vi√™n khi th·∫•y ƒëi·ªÅu b·∫•t th∆∞·ªùng."
            ];
            const BAD_TIPS = [
                "Tin nh·∫Øn vi·ªác nh·∫π l∆∞∆°ng cao ‚Üí Kh·∫£ nƒÉng l·ª´a ƒë·∫£o.", "Y√™u c·∫ßu b·ªè h·ªçc/ƒë·ªïi ƒë·ªùi nhanh ‚Üí C·ªù ƒë·ªè!",
                "ƒê√≤i ·∫£nh ƒë·ªùi t∆∞/nh·∫°y c·∫£m ‚Üí Ch·∫∑n & b√°o c√°o.", "D·∫´n d·ª• ra g·∫∑p m·∫∑t n∆°i v·∫Øng ‚Üí Tuy·ªát ƒë·ªëi kh√¥ng!",
                "Link l·∫° y√™u c·∫ßu ƒëƒÉng nh·∫≠p ‚Üí L·ª´a l·∫•y m·∫≠t kh·∫©u."
            ];
            const GOODS = ["Ch·ªâ k·∫øt b·∫°n ng∆∞·ªùi quen", "Kh√¥ng chia s·∫ª ·∫£nh nh·∫°y c·∫£m", "B·∫≠t 2FA", "Ki·ªÉm ch·ª©ng t√†i kho·∫£n", "B√°o c√°o k·∫ª x·∫•u", "Gi·ªØ ri√™ng t∆∞", "·ª®ng x·ª≠ vƒÉn minh", "Nh·ªù ng∆∞·ªùi l·ªõn h·ªó tr·ª£"];
            const BADS = ["Vi·ªác nh·∫π l∆∞∆°ng cao", "G·ª≠i ·∫£nh nh·∫°y c·∫£m", "Link l·ª´a ƒë·∫£o", "H·∫πn g·∫∑p n∆°i v·∫Øng", "N·ªãnh n·ªçt qu√° m·ª©c", "B·ªè h·ªçc ƒëi l√†m"];

            const AVATAR_MAP = {
                snake: { emoji: "üêç", body: "#22c55e" },
                cat: { emoji: "üê±", body: "#f97316" },
                dog: { emoji: "üê∂", body: "#7c2d12" },
                panda: { emoji: "üêº", body: "#6b7280" },
            };
            let currentAvatarKey = "snake";

            // ===== Tr·∫°ng th√°i =====
            let snake, dir, foods, bads, score, speedMul, hearts, gameOver, stepTimer, stepInterval;

            function reset() {
                snake = [{ x: 10, y: 10 }];
                dir = { x: 1, y: 0 };
                foods = [];
                bads = [];
                score = 0; speedMul = 1; hearts = 3; gameOver = false;
                stepInterval = 220; stepTimer = 0;
                // spawn ƒë·ªß s·ªë l∆∞·ª£ng t·ªëi ƒëa
                while (foods.length < FOOD_MAX) placeFoodOne();
                while (bads.length < BAD_MAX) placeBadOne();
                updateHUD();
            }

            function updateHUD() {
                document.getElementById('score').textContent = score;
                document.getElementById('speed').textContent = speedMul + 'x';
                const heartsEl = document.getElementById('hearts');
                heartsEl.innerHTML = '';
                for (let i = 0; i < hearts; i++) heartsEl.innerHTML += '<span class="heart">‚ô•</span>';
            }

            function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
            function randCellInner(m = INNER_MARGIN) { return { x: randInt(m, GRID - 1 - m), y: randInt(m, GRID - 1 - m) }; }
            function manhattan(a, b) { return Math.abs(a.x - b.x) + Math.abs(a.y - b.y); }
            function posEqual(a, b) { return a.x === b.x && a.y === b.y; }
            function cellOccupied(pos) {
                if (snake.some(s => posEqual(s, pos))) return true;
                if (foods.some(f => posEqual(f, pos))) return true;
                if (bads.some(b => posEqual(b, pos))) return true;
                return false;
            }

            function placeFoodOne() {
                let p, tries = 0;
                do {
                    p = randCellInner();
                    tries++;
                } while (
                    cellOccupied(p) ||
                    manhattan(p, snake[0]) < HEAD_SAFE_DIST ||
                    (tries < 3 && (p.x === snake[0].x || p.y === snake[0].y))
                );
                foods.push({ ...p, label: GOODS[Math.floor(Math.random() * GOODS.length)] });
            }

            function placeBadOne() {
                let p;
                do {
                    p = randCellInner();
                } while (
                    cellOccupied(p) ||
                    manhattan(p, snake[0]) < 2
                );
                bads.push({ ...p, label: BADS[Math.floor(Math.random() * BADS.length)] });
            }

            function showToast(msg, good = true) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.classList.remove('d-none');
                t.style.borderColor = good ? '#166534' : '#7f1d1d';
                t.style.background = good ? '#0b1f16' : '#1a0f0f';
                clearTimeout(t._timer);
                t._timer = setTimeout(() => t.classList.add('d-none'), 1400);
            }

            function endGame() {
                gameOver = true;
                document.getElementById('finalScore').textContent = score;
                const list = document.getElementById('tipsList'); list.innerHTML = '';
                const mix = [...shuffle(GOOD_TIPS).slice(0, 3), BAD_TIPS[Math.floor(Math.random() * BAD_TIPS.length)]];
                mix.forEach(t => { const li = document.createElement('li'); li.textContent = t; list.appendChild(li); });
                const modal = new bootstrap.Modal('#endModal'); modal.show();
            }
            function shuffle(a) { return a.map(v => [Math.random(), v]).sort((x, y) => x[0] - y[0]).map(x => x[1]); }

            // ===== Loop =====
            let last = performance.now();
            function loop(now) {
                const dt = now - last; last = now;
                if (!gameOver) {
                    stepTimer += dt;
                    if (stepTimer >= stepInterval) { stepTimer = 0; step(); }
                    draw();
                }
                requestAnimationFrame(loop);
            }

            function step() {
                const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
                // t∆∞·ªùng
                if (head.x < 0 || head.y < 0 || head.x >= GRID || head.y >= GRID) {
                    hearts--; updateHUD();
                    if (hearts <= 0) { endGame(); return; }
                    showToast("ƒê·ª•ng t∆∞·ªùng! B√¨nh tƒ©nh x·ª≠ l√≠ t√¨nh hu·ªëng.", false);
                    snake = [{ x: 10, y: 10 }]; dir = { x: 1, y: 0 }; return;
                }
                // th√¢n
                if (snake.some((s, i) => i > 0 && s.x === head.x && s.y === head.y)) {
                    hearts--; updateHUD();
                    if (hearts <= 0) { endGame(); return; }
                    showToast("T·ª± m√¢u thu·∫´n h√†nh vi ‚Üí r√† so√°t nguy√™n t·∫Øc an to√†n.", false);
                    snake = [{ x: 10, y: 10 }]; dir = { x: 1, y: 0 }; return;
                }
                snake.unshift(head);

                // ƒÉn food (nhi·ªÅu item)
                let ate = false;
                for (let i = 0; i < foods.length; i++) {
                    if (posEqual(head, foods[i])) {
                        ate = true;
                        showToast("üëç " + foods[i].label, true);
                        foods.splice(i, 1);
                        placeFoodOne(); // gi·ªØ ƒë·ªß s·ªë l∆∞·ª£ng
                        score++;
                        if (score % 5 === 0 && stepInterval > 120) { speedMul++; stepInterval -= 12; updateHUD(); }
                        break;
                    }
                }
                if (!ate) { snake.pop(); }

                // va bad (nhi·ªÅu item)
                for (let i = 0; i < bads.length; i++) {
                    if (posEqual(head, bads[i])) {
                        hearts--; updateHUD();
                        showToast("‚ö† " + bads[i].label, false);
                        bads.splice(i, 1);
                        placeBadOne(); // gi·ªØ ƒë·ªß s·ªë l∆∞·ª£ng
                        if (hearts <= 0) { endGame(); return; }
                        break;
                    }
                }
            }

            function draw() {
                const w = canvas.width, h = canvas.height;
                const cellW = w / GRID, cellH = h / GRID;

                ctx.fillStyle = '#0a0f1d'; ctx.fillRect(0, 0, w, h);
                ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
                for (let i = 1; i < GRID; i++) {
                    ctx.beginPath(); ctx.moveTo(i * cellW, 0); ctx.lineTo(i * cellW, h); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, i * cellH); ctx.lineTo(w, i * cellH); ctx.stroke();
                }

                // foods
                for (const f of foods) {
                    roundRect(ctx, f.x * cellW + 2, f.y * cellH + 2, cellW - 4, cellH - 4, 8, '#16a34a');
                    drawLabel(f, cellW, cellH, '#a7f3d0');
                }
                // bads
                for (const b of bads) {
                    roundRect(ctx, b.x * cellW + 2, b.y * cellH + 2, cellW - 4, cellH - 4, 8, '#dc2626');
                    drawLabel(b, cellW, cellH, '#fecaca');
                }

                // snake
                const { emoji, body } = AVATAR_MAP[currentAvatarKey] || AVATAR_MAP.snake;
                snake.forEach((s, i) => {
                    if (i === 0) {
                        const fontSize = Math.floor(cellW * 0.8);
                        ctx.font = `${fontSize}px system-ui, "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji"`;
                        ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        ctx.fillText(emoji, s.x * cellW + cellW / 2, s.y * cellH + cellH / 2 + 1);
                    } else {
                        roundRect(ctx, s.x * cellW + 2, s.y * cellH + 2, cellW - 4, cellH - 4, 6, body);
                    }
                });
            }

            function roundRect(ctx, x, y, w, h, r, fill) {
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.arcTo(x + w, y, x + w, y + h, r);
                ctx.arcTo(x + w, y + h, x, y + h, r);
                ctx.arcTo(x, y + h, x, y, r);
                ctx.arcTo(x, y, x + w, y, r);
                ctx.closePath();
                ctx.fillStyle = fill; ctx.fill();
            }
            function drawLabel(obj, cellW, cellH, color) {
                ctx.fillStyle = color;
                ctx.font = `${Math.round(cellW * 0.22)}px system-ui`;
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                const text = obj.label.length > 12 ? obj.label.slice(0, 12) + '‚Ä¶' : obj.label;
                ctx.fillText(text, obj.x * cellW + cellW / 2, obj.y * cellH + cellH / 2);
            }

            // ===== ƒêi·ªÅu khi·ªÉn =====
            const keyMap = { ArrowUp: { x: 0, y: -1 }, ArrowDown: { x: 0, y: 1 }, ArrowLeft: { x: -1, y: 0 }, ArrowRight: { x: 1, y: 0 } };
            document.addEventListener('keydown', e => { if (keyMap[e.key]) setDir(keyMap[e.key]); });
            const qs = id => document.getElementById(id);
            ['up', 'down', 'left', 'right'].forEach(k => {
                if (qs(k)) qs(k).onclick = () => setDir({ up: { x: 0, y: -1 }, down: { x: 0, y: 1 }, left: { x: -1, y: 0 }, right: { x: 1, y: 0 } }[k]);
            });
            function setDir(d) { if (snake.length > 1 && (d.x === -dir.x && d.y === -dir.y)) return; dir = d; }

            // Joystick
            const joy = document.getElementById('joystick');
            const knob = document.getElementById('joyStick');
            let joyActive = false;
            let joyCenter = { x: 0, y: 0 };
            const R = 70, r = 56 / 2, DEADZONE = 18;
            function getCenter(el) { const rect = el.getBoundingClientRect(); return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 }; }
            function handleJoyMove(clientX, clientY) {
                const dx = clientX - joyCenter.x, dy = clientY - joyCenter.y;
                const dist = Math.min(Math.hypot(dx, dy), R - r);
                const angle = Math.atan2(dy, dx);
                knob.style.transform = `translate(${Math.cos(angle) * dist}px, ${Math.sin(angle) * dist}px)`;
                const ax = Math.abs(dx), ay = Math.abs(dy);
                if (Math.max(ax, ay) > DEADZONE) { if (ax > ay) setDir({ x: dx > 0 ? 1 : -1, y: 0 }); else setDir({ x: 0, y: dy > 0 ? 1 : -1 }); }
            }
            function resetKnob() { knob.style.transform = 'translate(0,0)'; }
            joy.addEventListener('touchstart', (e) => { joyActive = true; joyCenter = getCenter(joy); const t = e.touches[0]; handleJoyMove(t.clientX, t.clientY); }, { passive: true });
            joy.addEventListener('touchmove', (e) => { if (!joyActive) return; const t = e.touches[0]; handleJoyMove(t.clientX, t.clientY); }, { passive: true });
            joy.addEventListener('touchend', () => { joyActive = false; resetKnob(); }, { passive: true });
            joy.addEventListener('touchcancel', () => { joyActive = false; resetKnob(); }, { passive: true });

            // Avatar ch·ªçn
            document.querySelectorAll('.avatar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const key = btn.getAttribute('data-avatar');
                    if (AVATAR_MAP[key]) currentAvatarKey = key;
                });
            });

            // Init
            reset(); requestAnimationFrame(loop);
            document.getElementById('btnRestart').onclick = () => reset();
            document.getElementById('playAgain').onclick = () => reset();

        })();
    </script>
</body>

</html>